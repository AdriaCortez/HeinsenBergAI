import express from 'express' //sem esse import eu não tenho acesso às funções do express
import mongoose from 'mongoose';
import cors from "cors";

const app = express(); 
const port = 3000; //A porta que o servidor escuta;

const { Schema, model } = mongoose;

//Schema = define a estrutura de um documento dentro de uma coleção no MongoDB. Ele organiza.
//Model = é a interface entre o código e o MongoDB e vai ligar os dois. Responsável pelo CRUD e o objeto que representa a coleção do banco de dados.
//Portiflio vira a coleção portifolios dentro do MongoDB.

const portifolioSchema = new Schema({
  nomeCompleto: String,
  cpf: String,
  data: String,
}); //O schema define que todos os valores colocados em cada uma das constantes sejam strings 

const Portifolio = model('Portifolio', portifolioSchema); //Define que o nome do model é portifolio usando um schema específico

/*Nota: Aí dá pra fazer Portifolio.create, find, deleteOne e tudo mais*/

//Caminho pra conectar ao banco de dados (disponibilizado no mongo pra web):
const uri = "mongodb+srv://adriacortzss_db_user:kRUOkdcuGkK35PNK@portifolio.oyudx7k.mongodb.net/portifolio?retryWrites=true&w=majority&appName=portifolio";

// -----------------------------
//  MIDDLEWARES — DEVEM VIR ANTES DAS ROTAS E DO LISTEN
// -----------------------------
app.use(express.json()); //Lê o Json que chega na requisição, transforma em um objeto JavaScript e coloca em req.body

app.use(cors({
  origin: "http://localhost:5173",
  methods: ["GET", "POST", "DELETE", "PUT"],
}));

//Para liberar o preflight OPTIONS pro DELETE
app.options("/delete-portifolio", cors());


// --- ROTAS ---
app.get('/', (req, res) => {
  res.send('Hello World!')
}); //define uma rota (no caso '/' que é a rota raiz e envia uma resposta pra quem acessou a rota)


//cria a rota ('/save-portifolio') que vai pegar os dados do reac
app.post('/save-portifolio', async (req, res) => { //A função é assync porque vamos usar await dentro dela pra salar no banco.
    //Req e res é o que o cliente enviou e o que o servidor vai responder.

  try { 
   const portifolio = await Portifolio.create({ //o banco vai criar um novo documento no Mongo contendo um objeto com os dados enviados pelo cliente
      nomeCompleto: req.body.nomeCompleto, //re.body é o corpo da requisição.
      cpf: req.body.cpf,
      data: req.body.data,
    });

    console.log('Portifolio Criado:', portifolio); //se tudo der certo o schema "portifolio" vai ser criado 

    res.json({
      message: "Portifólio salvo!",
      portifolio,
    }); //O servidorr manda uma mensagem no formato Json pra informar que o portifolio foi salvo.

  } catch (err) {
    console.error(err);
    res.status(500).json({ message: "Erro ao salvar", error: err });
  }
}); 


app.delete('/delete-portifolio', async (req, res) => {
  try { 
   const portifolio = await Portifolio.deleteMany({}); //o banco vai deletar os dados criados

    console.log('Portifolio deletado do banco de dados', portifolio); //mostra no console a operação realizada 

    res.json({
      message: "Portifólio deletado!",
      portifolio,
    }); //O servidor manda uma resposta informando que deletou.

  } catch (err) {
    console.error(err);
    res.status(500).json({ message: "Erro ao deletar. Tente novamente", error: err });
  }
});

app.put('/update-portifolio', async (req, res) => {
  try {
     const atualizacao = await Portifolio.findOneAndUpdate(
      {}, //Identifica quem o usuário quer atualizar pelo id, procura apenas 1 documento

      {
      $set: {
          nomeCompleto: req.body.nomeCompleto,
          cpf: req.body.cpf,
          data: req.body.data,
        } //atualiza novas informações
      },

      {
        sort: {_id: -1}, //pega o id mais recente colocado no mongo
        new: true //significa que a função vai retornar o documento atualizado
      }
    );

    console.log('Atualizado com sucesso', atualizacao);
    res.json(atualizacao); 

  } catch (err) {
    console.error(err);
    res.status(500).json({message:"Erro ao tentar atualizar informações. Tente novamente", error: err});
  }
});

app.get('/read-portifolio', async (req, res) => {
  try {
     const achado = await Portifolio.find(
      {}, 

     );

    console.log('Documento criado:', achado);
    res.json(achado);

  } catch (err) {
    console.error(err);
    res.status(500).json({message:"Erro: Não foi possível fazer a leitura do portifólio enviado. Tente novamente", 
    error: err});
  }
});



// FUNÇÃO PARA INICIAR O SERVIDOR

async function start() {
  try { //tenta rodar o código

    //Função pra conectar com o MongoDB
    await mongoose.connect(uri, { //Uri foi declarado ali em cima
      serverSelectionTimeoutMS: 15000,
    }); //Espera até 15 segundos pra conectar

    console.log("Mongoose conectado com sucesso!");

    app.listen(port, () => {
      console.log(`Express na porta ${port}`);
    }); //Mostra no console a porta que o express está

  } catch (err) {
    console.error("Erro ao conectar ao MongoDB:", err);
  } //Passando os 15 segundos, retorna um erro
}


//Inicia o servidor
start();

/*Aqui criamos um servidor express
    Definindo a porta 3000 e mostrando que o servidor escuta as requisições nessa porta
    Define a estrutura dos documentos (tipo string)
    Depois ele vai criar uma coleção
    Conecta ao Mongo
    Criamos a rota post que recebe os dados do front end (react)
    Usamos o Model Portifolio pra criar um novo documento no banco
    Salva no Mongo
    Manda uma resposta em JSON indicando que o portifolio foi salvo.*/
