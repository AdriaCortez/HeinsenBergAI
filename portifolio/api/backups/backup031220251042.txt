import express from 'express' //sem esse import eu n√£o tenho acesso √†s fun√ß√µes do express
import mongoose from 'mongoose';
import cors from "cors";

const app = express(); 
const port = 3000; //A porta que o servidor escuta;

const { Schema, model } = mongoose;

//Schema = define a estrutura de um documento dentro de uma cole√ß√£o no MongoDB. Ele organiza.
//Model = √© a interface entre o c√≥digo e o MongoDB e vai ligar os dois. Respons√°vel pelo CRUD e o objeto que representa a cole√ß√£o do banco de dados.
//Portiflio vira a cole√ß√£o portifolios dentro do MongoDB.

const portifolioSchema = new Schema({
  nomeCompleto: String,
  cpf: String,
  data: String,
}); //O schema define que todos os valores colocados em cada uma das constantes sejam strings 

const Portifolio = model('Portifolio', portifolioSchema); //Define que o nome do model √© portifolio usando um schema espec√≠fico

/*Nota: A√≠ d√° pra fazer Portifolio.create, find, deleteOne e tudo mais*/

//Caminho pra conectar ao banco de dados (disponibilizado no mongo pra web):
const uri =  "mongodb+srv://adriacortzss_db_user:kRUOkdcuGkK35PNK@portifolio.oyudx7k.mongodb.net/portifolio?retryWrites=true&w=majority&appName=portifolio";
// -----------------------------
//  MIDDLEWARES ‚Äî DEVEM VIR ANTES DAS ROTAS E DO LISTEN
// -----------------------------
app.use(express.json()); //L√™ o Json que chega na requisi√ß√£o, transforma em um objeto JavaScript e coloca em req.body

app.use(cors({
  origin: "http://localhost:5173",
  methods: ["GET", "POST", "DELETE", "PUT"],
}));

//Para liberar o preflight OPTIONS pro DELETE
app.options("/delete-portifolio", cors());


// --- ROTAS ---
app.get('/', (req, res) => {
  res.send('Hello World!')
}); //define uma rota (no caso '/' que √© a rota raiz e envia uma resposta pra quem acessou a rota)


//cria a rota ('/save-portifolio') que vai pegar os dados do reac
app.post('/save-portifolio', async (req, res) => { //A fun√ß√£o √© assync porque vamos usar await dentro dela pra salar no banco.
    //Req e res √© o que o cliente enviou e o que o servidor vai responder.

  try { 
   const portifolio = await Portifolio.create({ //o banco vai criar um novo documento no Mongo contendo um objeto com os dados enviados pelo cliente
      nomeCompleto: req.body.nomeCompleto, //re.body √© o corpo da requisi√ß√£o.
      cpf: req.body.cpf,
      data: req.body.data,
    });

    console.log('Portifolio Criado:', portifolio); //se tudo der certo o schema "portifolio" vai ser criado 

    res.json({
      message: "Portif√≥lio salvo!",
      portifolio,
    }); //O servidorr manda uma mensagem no formato Json pra informar que o portifolio foi salvo.

  } catch (err) {
    console.error(err);
    res.status(500).json({ message: "Erro ao salvar", error: err });
  }
}); 


app.delete('/delete-portifolio', async (req, res) => {
  try { 
   const portifolio = await Portifolio.deleteMany({}); //o banco vai deletar todos os dados criados

    console.log('Portifolio deletado do banco de dados', portifolio); //mostra no console a opera√ß√£o realizada 

    res.json({
      message: "Portif√≥lio deletado!",
      portifolio,
    }); //O servidor manda uma resposta informando que deletou.

  } catch (err) {
    console.error(err);
    res.status(500).json({ message: "Erro ao deletar. Tente novamente", error: err });
  }
});

// üõ†Ô∏è ROTA CORRIGIDA: Deleta o √∫ltimo documento inserido
app.delete('/delete-portifolio-data', async (req, res) => {
  try { 
    // findOneAndDelete com sort: {_id: -1} garante que o √∫ltimo documento criado ser√° deletado.
    const portifolio = await Portifolio.findOneAndDelete(
        {}, //Considera todos os documentos
        {
          sort: {_id: -1},
        }
    ); //o banco vai deletar o √∫ltimo dado criado com o sort

    if(!portifolio) { //'!' Vai no portifolio e verifica se ele t√° vazio
      // Se n√£o encontrou e n√£o deletou nada, retorna erro 404 no console
      return res.status(404).json({ message: "Cadastro n√£o encontrado (provavelmente banco vazio)"})
    } //se nada for deletado, retorna um status 404 com a mensagem cadastrp n√£o encontrado

    console.log('Portifolio deletado da tabela', portifolio); //mostra no console a opera√ß√£o realizada 

    res.json({
      message: "Portif√≥lio deletado da tabela!", portifolio,
    }); //O servidor manda uma resposta informando que deletou.

  } catch (err) {
    console.error(err);
    res.status(500).json({ message: "Erro ao deletar. Tente novamente", error: err });
  }
}); //Caso n√£o d√™ cert, retorna um erro 500

app.put('/update-portifolio', async (req, res) => {
  try {
     const atualizacao = await Portifolio.findOneAndUpdate(
      {}, //Identifica quem o usu√°rio quer atualizar pelo id, procura apenas 1 documento

      {
      $set: {
          nomeCompleto: req.body.nomeCompleto,
          cpf: req.body.cpf,
          data: req.body.data,
        } //atualiza novas informa√ß√µes
      },

      {
        sort: {_id: -1}, //pega o id mais recente colocado no mongo
        new: true //significa que a fun√ß√£o vai retornar o documento atualizado
      }
    );

    console.log('Atualizado com sucesso', atualizacao);
    res.json(atualizacao); 

  } catch (err) {
    console.error(err);
    res.status(500).json({message:"Erro ao tentar atualizar informa√ß√µes. Tente novamente", error: err});
  }
});

app.get('/read-portifolio', async (req, res) => {
  try {
     const achado = await Portifolio.find( //find √© uma fun√ß√£o do mongoose
      {}, //Aqui ele vai tentar encontrar todos os cadastros criados

     );

    console.log('Documento criado:', achado); //retorna no console
    res.json(achado);

  } catch (err) {
    console.error(err);
    res.status(500).json({message:"Erro: N√£o foi poss√≠vel fazer a leitura do portif√≥lio enviado. Tente novamente", 
    error: err});
  }
});



// FUN√á√ÉO PARA INICIAR O SERVIDOR

async function start() {
  try { //tenta rodar o c√≥digo

    //Fun√ß√£o pra conectar com o MongoDB
    await mongoose.connect(uri, { //Uri foi declarado ali em cima
      serverSelectionTimeoutMS: 15000,
    }); //Espera at√© 15 segundos pra conectar

    console.log("Mongoose conectado com sucesso!");

    app.listen(port, () => {
      console.log(`Express na porta ${port}`);
    }); //Mostra no console a porta que o express est√°

  } catch (err) {
    console.error("Erro ao conectar ao MongoDB:", err);
  } //Passando os 15 segundos, retorna um erro
}


//Inicia o servidor
start();

/*Aqui criamos um servidor express
    Definindo a porta 3000 e mostrando que o servidor escuta as requisi√ß√µes nessa porta
    Define a estrutura dos documentos (tipo string)
    Depois ele vai criar uma cole√ß√£o
    Conecta ao Mongo
    Criamos a rota post que recebe os dados do front end (react)
    Usamos o Model Portifolio pra criar um novo documento no banco
    Salva no Mongo
    Manda uma resposta em JSON indicando que o portifolio foi salvo.*/